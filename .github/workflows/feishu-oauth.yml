name: Feishu OAuth Handler
on: 
  repository_dispatch:
    types: [feishu_oauth]

jobs:
  process:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate input code
        id: validate_code
        run: |
          if [ -z "${{ github.event.client_payload.code }}" ]; then
            echo "::error::æˆæƒç ä¸ºç©ºï¼Œè¯·æ£€æŸ¥é£ä¹¦å›è°ƒå‚æ•°"
            exit 1
          else
            echo "âœ… æˆæƒç æ ¡éªŒé€šè¿‡"
            echo "CODE=${{ github.event.client_payload.code }}" >> $GITHUB_ENV
          fi

      - name: Exchange code for token
        id: get_token
        run: |
          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" -X POST \
            "https://open.feishu.cn/open-apis/authen/v1/access_token" \
            -H "Content-Type: application/json" \
            -d '{
              "grant_type": "authorization_code",
              "code": "'$CODE'",
              "app_id": "${{ secrets.FEISHU_APP_ID }}",
              "app_secret": "${{ secrets.FEISHU_APP_SECRET }}"
            }')

          # æå–HTTPçŠ¶æ€ç å’Œå“åº”ä½“
          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d':' -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/d')

          if [ "$HTTP_STATUS" != "200" ]; then
            echo "::error::é£ä¹¦APIè¯·æ±‚å¤±è´¥ (çŠ¶æ€ç : $HTTP_STATUS)"
            echo "å“åº”å†…å®¹: $BODY"
            exit 1
          fi

          # æ ¡éªŒå“åº”ä½“æ˜¯å¦åŒ…å«access_token
          if ! echo "$BODY" | jq -e '.data.access_token' > /dev/null; then
            echo "::error::é£ä¹¦å“åº”ç¼ºå°‘access_token"
            echo "å“åº”å†…å®¹: $BODY"
            exit 1
          fi

          echo "TOKEN_RESPONSE=$BODY" >> $GITHUB_ENV
          echo "âœ… ä»¤ç‰Œè·å–æˆåŠŸ"

      - name: Save token
        env:
          GH_TOKEN: ${{ secrets.PAT }}
        run: |
          # åˆ›å»ºtokenå­˜å‚¨ç›®å½•
          mkdir -p tokens
          echo "$TOKEN_RESPONSE" > tokens/$(date +%Y%m%d_%H%M%S).json

          # æäº¤åˆ°Gitä»“åº“
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add tokens/*
          git commit -m "[Auto] æ›´æ–°é£ä¹¦è®¿é—®ä»¤ç‰Œ $(date +%Y-%m-%d)"
          git push "https://x-access-token:$GH_TOKEN@github.com/${{ github.repository }}.git"

      - name: Final check
        run: |
          echo "ğŸ‰ æ‰€æœ‰æ­¥éª¤æ‰§è¡Œå®Œæˆ"
          echo "ä»¤ç‰Œå·²ä¿å­˜åˆ°ä»“åº“çš„ tokens/ ç›®å½•"
