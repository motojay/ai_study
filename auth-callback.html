<script>
// 从 URL 查询参数中获取 code 并进行编码
const code = encodeURIComponent(new URLSearchParams(window.location.search).get('code'));
// 假设后端通过全局变量将 GITHUB_TOKEN 传递给前端
const DEPLOY_TOKEN = window.GITHUB_TOKEN; 

// 输出 DEPLOY_TOKEN 用于调试
console.log('获取到的 DEPLOY_TOKEN:', DEPLOY_TOKEN);

if (code && DEPLOY_TOKEN) {
  fetch('https://api.github.com/repos/motojay/ai_study/dispatches', {
    method: 'POST',
    headers: {
      'Authorization': `token ${DEPLOY_TOKEN}`,
      'Accept': 'application/vnd.github.everest-preview+json',
      'Content-Type': 'application/json'
    },
    // 构建包含编码后 code 的请求体
    body: JSON.stringify({ 
      event_type: 'feishu_oauth', 
      client_payload: { code } 
    })
  }).then(response => {
    if (!response.ok) throw new Error('API 返回错误状态');
    alert('授权成功！Token 将在后台处理。');
    window.location.href = 'https://飞书应用主页'; // 跳转到飞书
  }).catch(err => {
    console.error('授权失败:', err);
    alert('授权失败: ' + err.message);
  });
} else {
  console.error('未获取到授权码或 Token');
  alert('未获取到授权码或 Token');
}
</script>
